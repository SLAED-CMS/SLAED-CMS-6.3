# SLAED CMS 6.3 - Анализ архитектуры системы

## Обзор системы

**Версия:** 6.3
**PHP:** 8.4.13
**БД:** MySQL 8.0+ / MariaDB 10+
**Автор:** Eduard Laas
**Лицензия:** GNU GPL 3
**Сайт:** slaed.net

## Структура проекта

### Корневая директория
```
E:\OSPanel\home\slaed.loc\public\
├── index.php              # Точка входа для фронтенда
├── admin.php              # Точка входа для админ-панели
├── setup.php              # Установщик системы
├── .htaccess              # Конфигурация Apache
├── robots.txt             # SEO конфигурация
├── sitemap.xml            # Карта сайта
└── favicon.ico            # Иконка сайта
```

### Основные директории

#### `/core/` - Ядро системы
- **core.php** (271 KB) - Главный файл ядра, основные функции
- **admin.php** (49 KB) - Функции админ-панели
- **security.php** (48 KB) - Система безопасности
- **user.php** (49 KB) - Пользовательские функции
- **template.php** (8 KB) - Шаблонизатор
- **forum.php** (36 KB) - Функции форума
- **geo_ip.php** + geo_ip.dat - Геолокация по IP
- **access.php** - Управление доступом

**Подпапки:**
- `/core/classes/` - Классы работы с БД
  - `mysqli.php` - MySQLi драйвер
  - `pdo.php` - PDO драйвер

#### `/config/` - Конфигурация
Централизованное хранилище настроек:
- **000config.php** - Основной конфиг (резервные копии)
- **000config_global.php** - Глобальные настройки
- **config_db.php** - Настройки БД (MySQLi, utf8mb4, InnoDB)
- **config_global.php** - Конфигурация системы (187 параметров)
- **config_security.php** - Параметры безопасности
- **config_seo.php** - SEO настройки
- **config_rewrite.php** - URL Rewriting
- **config_users.php** - Настройки пользователей
- Модульные конфиги: `config_[module].php`

**Подпапки:**
- `/config/backup/` - Резервные копии конфигов
- `/config/cache/` - Кеш конфигураций
- `/config/counter/` - Данные счетчиков
- `/config/logs/` - Логи системы
- `/config/sitemap/` - Файлы карты сайта

#### `/modules/` - Модули функционала
Модульная архитектура, каждый модуль в отдельной папке:

**Основные модули:**
- `account` - Управление аккаунтами
- `news` - Новости (основной модуль по умолчанию)
- `forum` - Форум
- `content` - Контент/статьи
- `pages` - Статические страницы
- `shop` - Интернет-магазин
- `files` - Файловый менеджер
- `media` - Медиа галерея
- `links` - Каталог ссылок
- `auto_links` - Автоматические ссылки
- `faq` - FAQ/ЧаВо
- `help` - Справка
- `jokes` - Развлекательный контент
- `contact` - Контактная форма
- `search` - Поиск
- `voting` - Голосования
- `users` - Пользователи
- `clients` - Клиенты
- `recommend` - Рекомендации
- `rss_info` - RSS информация
- `sitemap` - Карта сайта
- `money` - Финансы
- `order` - Заказы
- `image` - Изображения
- `main` - Главная страница

#### `/templates/` - Шаблоны оформления
- `admin/` - Админ-панель
- `default/` - Стандартная тема
- `lite/` - Облегченная тема

#### `/plugins/` - JavaScript и внешние библиотеки
- `jquery/` - jQuery библиотека + UI
- `ckeditor/` - WYSIWYG редактор
- `codemirror/` - Редактор кода
- `tinymce/` - Альтернативный редактор
- `fancybox/` - Lightbox для изображений
- `syntaxhighlighter/` - Подсветка синтаксиса
- `uploadify/` - Загрузка файлов
- `filemanager/` - Файловый менеджер
- `sxd/` - Кастомные плагины
- `system/` - Системные скрипты

#### `/admin/` - Админ-панель
Структура:
- `info/` - Информационные страницы
- `language/` - Языки админки
- `links/` - Управление ссылками
- `modules/` - Модули админки

#### `/blocks/` - Блоки интерфейса
Переиспользуемые компоненты UI

#### `/language/` - Языковые файлы
Мультиязычная поддержка

#### `/storage/` - Хранилище данных
Внутренние данные системы:
- `backup/` - Резервные копии
- `cache/` - Кеш файлы
- `counter/` - Счетчики
- `logs/` - Логи
- `sitemap/` - Карта сайта

#### `/uploads/` - Загрузки пользователей
Пользовательский контент

#### `/sound/` - Аудио файлы
#### `/forum/` - Данные форума

## Архитектура системы

### 1. Точка входа (index.php)

**Процесс инициализации:**
1. Подключение ядра: `include('core/core.php')`
2. Проверка режима закрытия сайта
3. Обработка ошибок 404
4. Определение модуля через параметры `?name=moduleName`
5. Маршрутизация через параметр `go`:
   - Пусто → загрузка модуля
   - `1` → AJAX операции
   - `2` → Корзина покупок
   - `3` → Сервисные операции (backup, sitemap)
   - `4` → Загрузка файлов
   - `5` → Админ AJAX
   - `rss` → RSS канал
   - `search` → OpenSearch
   - `css` → Генерация CSS
   - `script` → Генерация JS

### 2. Ядро системы (core/core.php)

**Основные константы:**
- `BASE_DIR` - корень проекта
- `CONFIG_DIR` - директория конфигов
- `BACKUP_DIR`, `CACHE_DIR`, `COUNTER_DIR`, `LOGS_DIR`, `SITEMAP_DIR`
- `UPLOADS_DIR` - загрузки

**Ключевые компоненты:**
- Система безопасности (security.php)
- Управление пользователями (user.php)
- Шаблонизатор (template.php)
- Работа с БД (classes/mysqli.php или classes/pdo.php)

**Новые функции (PHP 8.4 совместимость):**
- `addFile()` - Запись/сжатие файлов
- `deleteDir()` - Безопасное удаление директорий
- `checkCompress()` - Проверка доступных методов сжатия
- `checkUniqueIp()` - Уникальные IP в логах
- SQL интерполяция с типизацией

### 3. База данных

**Конфигурация (config_db.php):**
```php
$confdb = [
    'type' => 'mysqli',      // mysqli или pdo
    'host' => 'slaed.loc',
    'name' => 'slaed',
    'uname' => 'root',
    'pass' => '',
    'prefix' => 'sport',     // Префикс таблиц
    'charset' => 'utf8mb4',
    'collate' => 'utf8mb4_unicode_ci',
    'engine' => 'InnoDB',
    'mode' => '1',
    'sync' => '1'
];
```

**Класс sql_db (mysqli.php):**
- Поддержка именованных (`:name`) и позиционных (`?`) плейсхолдеров
- Автоматическое экранирование через `sql_quote()`
- SQL интерполяция `sql_interpol()`
- Метрики производительности (timing)

### 4. Система модулей

**Загрузка модуля:**
1. Проверка активности в БД: `SELECT active, view, blocks FROM _modules WHERE title='name'`
2. Права доступа:
   - `view = 0` - публичный
   - `view = 1` - только зарегистрированные/группы
   - `view = 2` - только модераторы
3. Подключение: `include('modules/name/index.php')`

**Структура модуля:**
```
modules/[name]/
├── index.php       # Главный файл
├── admin.php       # Админка модуля (опционально)
├── language/       # Языки модуля
└── [другие файлы]
```

### 5. Система безопасности

**Основные механизмы:**
- Проверка `MODULE_FILE` / `ADMIN_FILE` констант
- SQL инъекции → Подготовленные запросы
- XSS → Фильтрация через `getVar()`
- CSRF → Токены сессий
- IP блокировка
- Геолокация и детекция ботов
- Цензура контента

### 6. Конфигурация (config_global.php)

**187+ параметров, включая:**
- `homeurl` - https://slaed.loc
- `sitename` - Название сайта
- `language` - russian (мультиязычность)
- `module` - news (модуль по умолчанию)
- `gtime` - Europe/Berlin
- `cache` / `cache_b` / `cache_t` - Кеширование
- `gzip` - Сжатие
- `rewrite` - ЧПУ
- `session` / `sess_t` - Сессии
- SEO: `keys`, `slogan`, `syntax`
- Безопасность: `censor`, `gfx_chk`
- Боты: `bots`, `botsact`, `fbots`

### 7. Система шаблонов

**Шаблонизатор (template.php):**
- Замена плейсхолдеров `{%variable%}`
- Функции: `setTemplateBasic()`, `setTemplateWarning()`
- Темизация через `get_theme()`
- CSS/JS оптимизация и объединение

### 8. Маршрутизация и URL

**Параметры запросов:**
- `?name=moduleName` - модуль
- `?op=operation` - операция
- `?go=N` - тип запроса
- `?file=filename` - файл модуля

**ЧПУ (config_rewrite.php):**
Поддержка красивых URL через mod_rewrite

### 9. AJAX операции

**go=1 (основные):**
- `rating` - Рейтинги
- `show_files` - Показ файлов
- `editcom` / `savecom` - Комментарии
- `prmess*` - Личные сообщения
- `favor*` - Избранное
- `avoting*` - Голосования

**go=5 (админ):**
- `ajax_cat` - Категории
- `ajax_block` - Блоки
- `blocks_order` - Сортировка
- `ajax_privat` - Приватные сообщения

## Технические особенности

### PHP 8.4 совместимость
- Строгая типизация параметров
- Return type declarations
- Современные функции файловой системы
- ZipArchive, gzopen, bzopen поддержка

### Безопасность
- SQL Prepared Statements
- XSS фильтрация
- CSRF токены
- IP логирование
- Детекция ботов
- reCAPTCHA интеграция

### Производительность
- Многоуровневое кеширование (страницы, блоки, CSS, JS)
- Gzip сжатие
- CSS/JS минификация и объединение
- Оптимизация запросов к БД

### SEO
- OpenSearch
- XML Sitemap
- RSS каналы
- Мета-теги и keywords
- ЧПУ (mod_rewrite)
- Geo IP таргетинг

### Мультиязычность
Поддерживаемые языки (автоопределение по IP):
- English
- Russian
- Ukrainian
- German
- French
- Polish

## Выводы

SLAED CMS 6.3 - это **модульная, масштабируемая CMS** с:

✅ **Сильные стороны:**
- Чистая модульная архитектура
- Гибкая система конфигурации
- Мощная система безопасности
- Продвинутое кеширование
- Мультиязычность из коробки
- Современный стек (PHP 8.4, MySQL 8.0, UTF-8MB4)
- Поддержка MySQLi и PDO
- Богатая экосистема модулей (27+)

⚠️ **Потенциальные улучшения:**
- Отсутствие Composer (можно добавить при необходимости)
- Процедурный стиль (можно модернизировать на ООП)
- Можно добавить автозагрузку классов (PSR-4)
- Модернизация JS (переход на современные фреймворки)

## Рекомендации для работы

1. **Разработка модулей:** Следовать структуре существующих
2. **Изменение ядра:** Осторожно, проверять совместимость
3. **Добавление функций:** Использовать hooks и events
4. **Тестирование:** На PHP 8.4 с включенным error_reporting
5. **Git:** Инициализировать репозиторий для версионного контроля

---
**Статус:** Система полностью инициализирована и готова к работе ✓
